<!DOCTYPE html>
<html lang="ar" dir="rtl" data-lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ŸÖŸÜÿµÿ© ÿ®ÿ´ ŸÅŸäÿØŸäŸà ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ© ŸÖÿπ ŸÜÿ∏ÿßŸÖ ÿØÿ®ŸÑÿ¨ÿ© ŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑŸÑÿ∫ÿßÿ™">
    <title>Watch VIP - ŸÖŸÜÿµÿ© ÿßŸÑÿ®ÿ´</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===========================
           ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ Ÿàÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿπÿßŸÖÿ©
        =========================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ff0000;
            --secondary-color: #282828;
            --bg-dark: #0f0f0f;
            --bg-light: #1f1f1f;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border-color: #303030;
            --success-color: #00ff00;
            --verified-color: #1da1f2;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        html[data-lang="ar"] body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        html[data-lang="en"] body,
        html[data-lang="fr"] body {
            font-family: 'Inter', sans-serif;
            direction: ltr;
        }

        html[data-lang="ja"] body {
            font-family: 'Noto Sans JP', sans-serif;
            direction: ltr;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: var(--bg-light);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .breadcrumb button {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            color: var(--verified-color);
            cursor: pointer;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .breadcrumb button:hover {
            background: var(--primary-color);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        .library-view {
            margin-bottom: 30px;
        }

        .library-header {
            padding: 15px 20px;
            background: var(--secondary-color);
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid var(--border-color);
        }

        .library-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: var(--bg-light);
            border-radius: 0 0 12px 12px;
        }

        .library-item {
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            overflow: hidden;
            background: var(--secondary-color);
            border: 2px solid transparent;
        }

        .library-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .item-cover {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .item-cover.episode {
            background-size: cover;
            background-position: 25% center;
        }

        .item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info {
            padding: 15px;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .video-section {
            background: var(--bg-light);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .video-header {
            padding: 15px 20px;
            background: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .video-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            flex: 1;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            background: #000;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-seek-wrapper {
            background: var(--secondary-color);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .time-display {
            font-size: 0.85rem;
            color: var(--verified-color);
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            white-space: nowrap;
        }

        #videoSeek {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-dark);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            transition: height 0.2s;
        }

        #videoSeek::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: all 0.2s;
        }

        #videoSeek::-webkit-slider-thumb:hover {
            width: 20px;
            height: 20px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
        }

        #videoSeek::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: all 0.2s;
        }

        #videoSeek::-moz-range-thumb:hover {
            width: 20px;
            height: 20px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
        }

        #videoSeek::-moz-range-track {
            background: transparent;
            border: none;
        }

        #videoSeek::-moz-range-progress {
            background: var(--primary-color);
            height: 6px;
            border-radius: 3px;
        }

        #videoSeek:hover {
            height: 8px;
        }

        .quick-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sys-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #2a2a2a;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            box-shadow: inset 0 0 0 2px #333;
            font-family: inherit;
            user-select: none;
        }

        .sys-toggle:hover {
            background: #333;
        }

        .sys-toggle.active {
            background: var(--primary-color);
            color: #fff;
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.6), inset 0 0 0 2px rgba(255,255,255,0.3);
        }

        .dub-selector {
            background: var(--secondary-color);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                overflow: hidden;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        .dub-selector h3 {
            margin-bottom: 12px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .dub-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .dub-btn {
            padding: 10px 18px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dub-btn:hover {
            border-color: var(--text-secondary);
            background: var(--bg-light);
        }

        .dub-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .dub-icon {
            font-size: 1.1rem;
        }

        .dub-status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #ff0000;
            border: 1px solid rgba(255, 0, 0, 0.2);
        }

        .dub-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #aaa;
            border-radius: 50%;
        }

        .dub-status-dot.active {
            background: var(--success-color);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .dub-audio-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .dub-audio-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }

        #audioSlider {
            flex: 1;
            min-width: 200px;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-dark);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        #audioSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: all 0.2s;
        }

        #audioSlider::-webkit-slider-thumb:hover {
            width: 22px;
            height: 22px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
        }

        #audioSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: all 0.2s;
        }

        #audioSlider::-moz-range-thumb:hover {
            width: 22px;
            height: 22px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
        }

        #audioSlider::-moz-range-track {
            background: transparent;
            border: none;
        }

        #audioSlider::-moz-range-progress {
            background: var(--primary-color);
            height: 6px;
            border-radius: 3px;
        }

        .dub-time-display {
            background: var(--bg-dark);
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--verified-color);
            font-weight: 600;
            min-width: 120px;
            text-align: center;
            white-space: nowrap;
        }

        .video-info {
            padding: 20px;
        }

        .video-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .video-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .comments-section {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .comments-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .comments-count {
            background: var(--secondary-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .comment-form {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--secondary-color);
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-secondary);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-dark);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: var(--text-primary);
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .submit-btn:hover:not(:disabled) {
            background: #cc0000;
            border-color: #cc0000;
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .status-message.error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .status-message.info {
            background: rgba(29, 161, 242, 0.1);
            border: 1px solid var(--verified-color);
            color: var(--verified-color);
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-item {
            background: var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            cursor: pointer;
        }

        .comment-item:hover {
            border-color: var(--text-secondary);
        }

        .comment-item.user-comment {
            border: 2px solid var(--primary-color);
            background: rgba(255, 0, 0, 0.05);
        }

        .comment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            color: var(--verified-color);
        }

        .verified-svg {
            width: 14px;
            height: 14px;
            margin-inline-start: 4px;
        }

        .comment-time {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .comment-text {
            color: var(--text-primary);
            line-height: 1.6;
            word-wrap: break-word;
        }

        .comment-actions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .click-count {
            font-weight: 500;
        }

        .no-comments {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .library-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .video-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .video-header h1 {
                font-size: 1.2rem;
            }

            .video-title {
                font-size: 1.1rem;
            }

            .comments-header h2 {
                font-size: 1.2rem;
            }

            .comment-form {
                padding: 15px;
            }

            .dub-buttons {
                flex-direction: column;
            }

            .dub-btn {
                width: 100%;
                justify-content: center;
            }

            .video-controls {
                width: 100%;
                justify-content: flex-start;
            }

            .dub-audio-controls {
                flex-direction: column;
            }

            #audioSlider {
                min-width: 100%;
            }

            .dub-time-display {
                width: 100%;
            }

            .video-seek-wrapper {
                flex-wrap: wrap;
                gap: 8px;
            }

            #videoSeek {
                width: 100%;
            }

            .time-display {
                min-width: 100%;
                text-align: center;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .library-item, .comment-item {
            animation: fadeIn 0.3s ease-out;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--secondary-color);
            color: var(--verified-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-family: inherit;
            font-weight: 500;
        }

        .back-btn:hover {
            background: var(--primary-color);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        .comments-update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .comments-update-indicator.paused {
            animation: none;
            opacity: 0.5;
        }

        #langToggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
            font-size: 0.7rem;
            font-weight: 600;
            border: 2px solid var(--text-primary);
            transition: all 0.3s;
            box-shadow: var(--shadow);
            text-align: center;
            padding: 5px;
        }

        #langToggle:hover {
            transform: scale(1.1);
            background: #cc0000;
        }

        #langMenu {
            position: fixed;
            right: 20px;
            bottom: 80px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            z-index: 9999;
            box-shadow: var(--shadow);
            min-width: 140px;
        }

        #langMenu button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: var(--secondary-color);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-family: inherit;
            font-weight: 500;
        }

        #langMenu button:hover {
            background: var(--primary-color);
            color: var(--text-primary);
        }

        #langMenu button.active {
            background: var(--primary-color);
            color: var(--text-primary);
            font-weight: 700;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dub-notice {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 10px 14px;
            line-height: 1.5;
        }

        .dub-arrows {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }

        .arrow-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: #1f1f1f;
            border: 1px solid #333;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .arrow-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .arrow-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="breadcrumb" id="breadcrumb">
            <button class="back-btn" id="backBtn" onclick="App.goHome()" style="display: none;"></button>
            <span id="breadcrumbText">ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©</span>
        </div>

        <div id="libraryView" class="library-view">
            <div class="library-header">
                <h1 id="libraryTitle">ÿßŸÑŸÖÿ≥ŸÑÿ≥ŸÑÿßÿ™</h1>
            </div>
            <div class="library-grid" id="libraryGrid"></div>
        </div>

        <div id="videoView" class="hidden">
            <div class="video-section">
                <div class="video-header">
                    <h1>
                        <span id="appTitle">Watch VIP</span>
                        <div id="dubLongPressHint" style="font-size:12px;color:#aaa;margin-top:4px;"></div>
                    </h1>
                    <div class="video-controls">
                        <div class="quick-toggle">
                            <button id="dubToggle" class="sys-toggle" title="ÿßŸÑÿØÿ®ŸÑÿ¨ÿ©">
                                <span class="icon">üîá</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="video-container" id="videoContainer"></div>

                <div class="video-seek-wrapper" id="seekWrapper">
                    <div id="preDubNotice" class="dub-notice"></div>

                    <div id="dubArrows" class="dub-arrows hidden">
                        <button class="arrow-btn" id="back1">‚è™</button>
                        <span class="arrow-label" id="seekHint"></span>
                        <button class="arrow-btn" id="forward1">‚è©</button>
                    </div>

                    <div id="legacySeek" class="hidden">
                        <span class="time-display" id="currentTime">00:00</span>
                        <input type="range" id="videoSeek" min="0" value="0" step="0.1" title="ÿ™ŸÇÿØŸÖ ÿßŸÑŸÅŸäÿØŸäŸà">
                        <span class="time-display" id="totalTime">00:00</span>
                    </div>
                </div>

                <div class="dub-selector" id="dubSelector" style="display: none;">
                    <h3 id="dubTitle">ÿßÿÆÿ™ÿ± ŸÜÿ≥ÿÆÿ© ÿßŸÑÿπÿ±ÿ∂:</h3>
                    <div class="dub-buttons" id="dubButtons"></div>
                    
                    <div class="dub-status-indicator" id="dubStatusIndicator">
                        <span class="dub-status-dot" id="statusDot"></span>
                        <span id="statusText">‚ñ∂ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÇŸäÿØ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ</span>
                    </div>

                    <div class="dub-audio-controls" id="dubAudioControls" style="display: none;">
                        <span class="dub-audio-label" id="audioLabel">ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑÿµŸàÿ™:</span>
                        <input
                            type="range"
                            id="audioSlider"
                            min="-10"
                            max="10"
                            value="0"
                            step="0.05"
                            title="ÿßÿ∂ÿ®ÿ∑ ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑÿµŸàÿ™ (ÿ´ÿßŸÜŸäÿ©)"
                        >
                        <div class="dub-time-display" id="timeDisplay">+0.00 ÿ´ÿßŸÜŸäÿ©</div>
                    </div>
                </div>

                <div class="video-info">
                    <h2 class="video-title" id="videoTitle">ÿßŸÑÿπŸÜŸàÿßŸÜ</h2>
                    <p class="video-description" id="videoDescription">ÿßŸÑŸàÿµŸÅ</p>
                </div>
            </div>

            <div class="comments-section">
                <div class="comments-header">
                    <h2>
                        <span class="comments-update-indicator paused" id="updateIndicator"></span>
                        <span id="commentsTitle">ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™</span>
                    </h2>
                    <span class="comments-count" id="commentsCount">0 ÿ™ÿπŸÑŸäŸÇ</span>
                </div>

                <div class="status-message" id="statusMessage"></div>

                <div class="comment-form">
                    <form id="commentForm">
                        <div class="form-group">
                            <label for="commentName" id="labelName">ÿßŸÑÿßÿ≥ŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                            <input 
                                type="text" 
                                id="commentName" 
                                maxlength="50"
                            >
                            <div class="form-hint" id="hintName">ÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿßÿ≥ŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ•ŸÜ ŸÑŸÖ ÿ™ŸÉÿ™ÿ®</div>
                        </div>
                        <div class="form-group">
                            <label for="commentText" id="labelComment">ÿßŸÑÿ™ÿπŸÑŸäŸÇ *</label>
                            <textarea 
                                id="commentText" 
                                required
                                maxlength="500"
                            ></textarea>
                        </div>
                        <button type="submit" class="submit-btn" id="submitBtn">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇ</button>
                    </form>
                </div>

                <div id="commentsListContainer">
                    <div class="loading" id="loadingText">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="langToggle" title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑÿ∫ÿ©"></div>

    <div id="langMenu" class="hidden">
        <button data-lang="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
        <button data-lang="en">English</button>
        <button data-lang="fr">Fran√ßais</button>
        <button data-lang="ja">Êó•Êú¨Ë™û</button>
    </div>

    <script>
// ============================================
// GLOBAL STATE & CONFIGURATION
// ============================================
const CONFIG = {
    BACKEND_URL: 'https://site--watch-vip--j9hb6dlmp4qm.code.run',
    REFRESH_INTERVAL: 10000,
    SUBMIT_COOLDOWN: 3000,
    LONG_PRESS_DURATION: 500
};

// YouTube API
let YTReady = false;
window.onYouTubeIframeAPIReady = function() {
    YTReady = true;
    DubEngine.setupPlayersWhenReady();
};

(function loadYouTubeAPI() {
    if (window.YT) {
        YTReady = true;
        return;
    }
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
})();

// ============================================
// DATA
// ============================================
const LIBRARY = {
    series: [
        {
            id: 'doraemon',
            title: 'ÿØŸàÿ±ÿßŸäŸÖŸàŸÜ',
            cover: 'covers/doraemon.jpg',
            episodes: [
                {
                    id: 'ep01',
                    title: 'ÿßŸÑÿ≠ŸÑŸÇÿ© 01 - ÿ®ÿØÿßŸäÿ© ÿØŸàÿ±ÿßŸäŸÖŸàŸÜ',
                    description: 'ŸÖÿØŸäŸÜÿ© ÿßŸÑÿ£ÿ≠ŸÑÿßŸÖ ‚Äì ÿ£ÿ±ÿ∂ ŸÜŸàÿ®Ÿäÿ™ÿß',
                    cover: 'covers/ep01.jpg',
                    versions: {
                        original: {
                            name: 'ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©',
                            icon: 'üé¨',
                            id: 'ZYycK1Paq4M'
                        },
                        arabic: {
                            name: 'ÿØÿ®ŸÑÿ¨ÿ© ÿπÿ±ÿ®Ÿäÿ©',
                            icon: 'üîä',
                            id: 'B_Ha4vu-qc8'
                        },
                        japanese: {
                            name: 'ÿØÿ®ŸÑÿ¨ÿ© Ÿäÿßÿ®ÿßŸÜŸäÿ©',
                            icon: 'üéß',
                            id: 'xYJpOiuPohQ'
                        }
                    }
                }
            ]
        }
    ]
};

const TRANSLATIONS = {
    ar: {
        library: 'ÿßŸÑŸÖÿ≥ŸÑÿ≥ŸÑÿßÿ™',
        back: '‚Üê ÿßŸÑÿ±ÿ¨Ÿàÿπ',
        comments: 'ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™',
        commentCount: (n) => `${n} ÿ™ÿπŸÑŸäŸÇ`,
        labelName: 'ÿßŸÑÿßÿ≥ŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)',
        hintName: 'ÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿßÿ≥ŸÖ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ•ŸÜ ŸÑŸÖ ÿ™ŸÉÿ™ÿ®',
        labelComment: 'ÿßŸÑÿ™ÿπŸÑŸäŸÇ *',
        placeholderName: 'ÿßÿ™ÿ±ŸÉ ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä',
        placeholderComment: 'ÿ¥ÿßÿ±ŸÉ ÿ±ÿ£ŸäŸÉ...',
        submit: 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇ',
        submitting: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...',
        noComments: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ',
        loading: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...',
        pending: 'ŸÑÿØŸäŸÉ ÿ™ÿπŸÑŸäŸÇ ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',
        empty: 'ÿ£ŸÉŸÖŸÑ ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÇ',
        success: 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ÿπŸÑŸäŸÇŸÉ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úì',
        error: 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ',
        canComment: 'ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ™ÿπŸÑŸäŸÇ ŸÖÿ¨ÿØÿØÿßŸã',
        rateLimitError: 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇŸÑŸäŸÑÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ',
        langButtonLabel: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑÿ∫ÿ©',
        dubTitle: 'ÿßÿÆÿ™ÿ± ŸÜÿ≥ÿÆÿ© ÿßŸÑÿπÿ±ÿ∂:',
        dubHint: 'ÿßŸÜŸÇÿ± ŸÑŸÑÿ™ÿ®ÿØŸäŸÑÿå ÿßÿ∂ÿ∫ÿ∑ ÿ∑ŸàŸäŸÑÿßŸã ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©',
        episodeCount: (n) => `${n} ÿ≠ŸÑŸÇÿ©`,
        statusMessages: {
            original: '‚ñ∂ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÇŸäÿØ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ',
            arabic: 'üîä ÿßŸÑÿØÿ®ŸÑÿ¨ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÖŸÅÿπŸÑÿ©',
            japanese: 'üéß ÿßŸÑÿØÿ®ŸÑÿ¨ÿ© ÿßŸÑŸäÿßÿ®ÿßŸÜŸäÿ© ŸÖŸÅÿπŸÑÿ©'
        },
        appTitle: 'Watch VIP',
        dubLongPressHint: 'ÿßÿ∂ÿ∫ÿ∑ ŸÖÿ∑ŸàŸëŸÑŸãÿß ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿØÿ®ŸÑÿ¨ÿ© ŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿØÿ®ŸÑÿ¨ÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©',
        preDubNotice: 'ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿ£ÿ¨ÿ≤ÿßÿ° ŸÖŸÜ ÿßŸÑÿ≠ŸÑŸÇÿ© ÿ∫Ÿäÿ± ŸÖÿØÿ®ŸÑÿ¨ÿ©ÿå ŸäŸèŸÅÿ∂ŸëŸÑ ÿ™ÿ±ŸÉ ÿßŸÑÿ≠ŸÑŸÇÿ© ÿ™ÿ≥Ÿäÿ± ÿ∑ÿ®ŸäÿπŸäŸãÿß ÿ®ÿπÿØ ŸÜÿ¨ÿßÿ≠ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©.',
        seekHint: '¬± 1 ÿ´ÿßŸÜŸäÿ©',
        audioLabel: 'ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑÿµŸàÿ™:'
    },
    en: {
        library: 'Series',
        back: 'Back',
        comments: 'Comments',
        commentCount: (n) => `${n} comment${n !== 1 ? 's' : ''}`,
        labelName: 'Name (Optional)',
        hintName: 'An automatic name will be generated if left blank',
        labelComment: 'Comment *',
        placeholderName: 'Leave blank for auto-generation',
        placeholderComment: 'Share your thoughts...',
        submit: 'Post Comment',
        submitting: 'Posting...',
        noComments: 'No comments yet',
        loading: 'Loading...',
        pending: 'Your comment is under review',
        empty: 'Please write a comment',
        success: 'Comment posted successfully ‚úì',
        error: 'Failed to send comment',
        canComment: 'You can comment again',
        rateLimitError: 'Please wait a moment before posting',
        langButtonLabel: 'Change Language',
        dubTitle: 'Choose Version:',
        dubHint: 'Click to toggle, long press to show menu',
        episodeCount: (n) => `${n} episode${n !== 1 ? 's' : ''}`,
        statusMessages: {
            original: '‚ñ∂ Original version is playing',
            arabic: 'üîä Arabic dub is enabled',
            japanese: 'üéß Japanese dub is enabled'
        },
        appTitle: 'Watch VIP',
        dubLongPressHint: 'Long press the dub button to select the appropriate dubbing',
        preDubNotice: 'Some parts of the episode may not be dubbed. It is recommended to let the episode play naturally after successful synchronization.',
        seekHint: '¬± 1 second',
        audioLabel: 'Audio Offset:'
    },
    fr: {
        library: 'S√©ries',
        back: 'Retour',
        comments: 'Commentaires',
        commentCount: (n) => `${n} commentaire${n !== 1 ? 's' : ''}`,
        labelName: 'Nom (Optionnel)',
        hintName: 'Un nom automatique sera g√©n√©r√© si laiss√© vide',
        labelComment: 'Commentaire *',
        placeholderName: 'Laisser vide pour la g√©n√©ration automatique',
        placeholderComment: 'Partagez vos pens√©es...',
        submit: 'Publier le commentaire',
        submitting: 'Publication...',
        noComments: 'Pas encore de commentaires',
        loading: 'Chargement...',
        pending: 'Votre commentaire est en attente d\'approbation',
        empty: 'Veuillez √©crire un commentaire',
        success: 'Commentaire publi√© avec succ√®s ‚úì',
        error: 'Erreur lors de l\'envoi',
        canComment: 'Vous pouvez commenter √† nouveau',
        rateLimitError: 'Veuillez attendre un moment avant de publier',
        langButtonLabel: 'Changer la Langue',
        dubTitle: 'Choisir la version:',
        dubHint: 'Cliquez pour basculer, appuyez longuement pour le menu',
        episodeCount: (n) => `${n} √©pisode${n !== 1 ? 's' : ''}`,
        statusMessages: {
            original: '‚ñ∂ La version originale est en cours de lecture',
            arabic: 'üîä Le doublage arabe est activ√©',
            japanese: 'üéß Le doublage japonais est activ√©'
        },
        appTitle: 'Watch VIP',
        dubLongPressHint: 'Appuyez longuement sur le bouton de doublage pour s√©lectionner le doublage appropri√©',
        preDubNotice: 'Certaines parties de l\'√©pisode peuvent ne pas √™tre doubl√©es. Il est recommand√© de laisser l\'√©pisode se jouer naturellement apr√®s une synchronisation r√©ussie.',
        seekHint: '¬± 1 seconde',
        audioLabel: 'D√©calage audio:'
    },
    ja: {
        library: '„Ç∑„É™„Éº„Ç∫',
        back: 'Êàª„Çã',
        comments: '„Ç≥„É°„É≥„Éà',
        commentCount: (n) => `${n}‰ª∂„ÅÆ„Ç≥„É°„É≥„Éà`,
        labelName: 'ÂêçÂâç („Ç™„Éó„Ç∑„Éß„É≥)',
        hintName: 'Á©∫ÁôΩ„ÅÆ„Åæ„Åæ„Å´„Åô„Çã„Å®„É©„É≥„ÉÄ„É†„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô',
        labelComment: '„Ç≥„É°„É≥„Éà *',
        placeholderName: 'Ëá™ÂãïÁîüÊàê„ÅÆ„Åü„ÇÅÁ©∫ÁôΩ„ÅÆ„Åæ„Åæ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        placeholderComment: '„ÅÇ„Å™„Åü„ÅÆËÄÉ„Åà„ÇíÂÖ±Êúâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...',
        submit: '„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø',
        submitting: 'ÊäïÁ®ø‰∏≠...',
        noComments: '„Åæ„Å†„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
        loading: 'Ë™≠„ÅøËæº„Åø‰∏≠...',
        pending: '„Ç≥„É°„É≥„Éà„ÅØÂØ©Êüª‰∏≠„Åß„Åô',
        empty: '„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        success: '„Ç≥„É°„É≥„Éà„ÅåÊ≠£Â∏∏„Å´ÊäïÁ®ø„Åï„Çå„Åæ„Åó„Åü ‚úì',
        error: 'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
        canComment: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Ç≥„É°„É≥„Éà„Åß„Åç„Åæ„Åô',
        rateLimitError: 'ÊäïÁ®ø„Åô„ÇãÂâç„Å´„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ',
        langButtonLabel: 'Ë®ÄË™û„ÇíÂ§âÊõ¥',
        dubTitle: '„Éê„Éº„Ç∏„Éß„É≥„ÇíÈÅ∏Êäû:',
        dubHint: '„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Âàá„ÇäÊõø„Åà„ÄÅÈï∑Êäº„Åó„Åó„Å¶„É°„Éã„É•„Éº„ÇíË°®Á§∫',
        episodeCount: (n) => `${n}„Ç®„Éî„ÇΩ„Éº„Éâ`,
        statusMessages: {
            original: '‚ñ∂ „Ç™„É™„Ç∏„Éä„É´„Éê„Éº„Ç∏„Éß„É≥„ÅåÂÜçÁîü‰∏≠',
            arabic: 'üîä „Ç¢„É©„Éì„Ç¢Ë™ûÂêπ„ÅçÊõø„Åà„ÅåÊúâÂäπ',
            japanese: 'üéß Êó•Êú¨Ë™ûÂêπ„ÅçÊõø„Åà„ÅåÊúâÂäπ'
        },
        appTitle: 'Watch VIP',
        dubLongPressHint: 'Âêπ„ÅçÊõø„Åà„Éú„Çø„É≥„ÇíÈï∑Êäº„Åó„Åó„Å¶ÈÅ©Âàá„Å™Âêπ„ÅçÊõø„Åà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
        preDubNotice: '„Ç®„Éî„ÇΩ„Éº„Éâ„ÅÆ‰∏ÄÈÉ®„ÅåÂêπ„ÅçÊõø„Åà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂêåÊúü„Å´ÊàêÂäü„Åó„ÅüÂæå„ÅØ„ÄÅ„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíËá™ÁÑ∂„Å´ÂÜçÁîü„Åô„Çã„Åì„Å®„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ',
        seekHint: '¬± 1 Áßí',
        audioLabel: '„Ç™„Éº„Éá„Ç£„Ç™„Ç™„Éï„Çª„ÉÉ„Éà:'
    }
};

// ============================================
// UTILITIES
// ============================================
const Utils = {
    sanitize(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    },

    formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return '00:00';
        const total = Math.floor(seconds);
        const mins = Math.floor(total / 60);
        const secs = total % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    },

    timeAgo(ts) {
        const diff = Date.now() - ts;
        const m = Math.floor(diff / 60000);
        const lang = document.documentElement.getAttribute('data-lang');
        
        const times = {
            ar: {
                now: 'ŸÑŸÑÿ™Ÿà',
                minutes: (n) => `ŸÖŸÜÿ∞ ${n} ÿØŸÇŸäŸÇÿ©`,
                hours: (n) => `ŸÖŸÜÿ∞ ${n} ÿ≥ÿßÿπÿ©`,
                days: (n) => `ŸÖŸÜÿ∞ ${n} ŸäŸàŸÖ`
            },
            en: {
                now: 'just now',
                minutes: (n) => `${n}m ago`,
                hours: (n) => `${n}h ago`,
                days: (n) => `${n}d ago`
            },
            fr: {
                now: '√† l\'instant',
                minutes: (n) => `il y a ${n}m`,
                hours: (n) => `il y a ${n}h`,
                days: (n) => `il y a ${n}j`
            },
            ja: {
                now: '‰ªä',
                minutes: (n) => `${n}ÂàÜÂâç`,
                hours: (n) => `${n}ÊôÇÈñìÂâç`,
                days: (n) => `${n}Êó•Ââç`
            }
        };

        const t = times[lang] || times.en;
        if (m < 1) return t.now;
        if (m < 60) return t.minutes(m);
        const h = Math.floor(m / 60);
        if (h < 24) return t.hours(h);
        return t.days(Math.floor(h / 24));
    },

    clientId() {
        let id = localStorage.getItem('watch_vip_client_id');
        if (!id) {
            id = Date.now().toString(36) + Math.random().toString(36).slice(2);
            localStorage.setItem('watch_vip_client_id', id);
        }
        return id;
    },

    status(msg, type='info') {
        const el = document.getElementById('statusMessage');
        el.textContent = msg;
        el.className = `status-message ${type} show`;
        setTimeout(()=>el.classList.remove('show'), 4000);
    },

    playHaptic() {
        if (navigator.vibrate) {
            navigator.vibrate(30);
        }
    }
};

// ============================================
// API
// ============================================
const API = {
    async submit(name, text) {
        try {
            const r = await fetch(`${CONFIG.BACKEND_URL}/submit-comment`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    name, text,
                    clientId: Utils.clientId()
                })
            });
            if (!r.ok) throw new Error('Failed');
            return r.json();
        } catch (e) {
            throw new Error('Connection error');
        }
    },

    async comments() {
        try {
            const r = await fetch(`${CONFIG.BACKEND_URL}/comments`);
            return r.ok ? r.json() : [];
        } catch {
            return [];
        }
    }
};

// ============================================
// DUB ENGINE
// ============================================
const DubEngine = {
    state: {
        isReady: false,
        currentMode: 'original',
        mainPlayer: null,
        audioPlayers: {},
        userSeeking: false
    },

    audioTimeUpdateInterval: null,

    async init(mainId, versions) {
        this.cleanup();

        const container = document.getElementById('videoContainer');
        let html = `<iframe id="dub-main"
            src="https://www.youtube.com/embed/${mainId}?enablejsapi=1&controls=1&modestbranding=1&rel=0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>`;

        Object.entries(versions).forEach(([key, version]) => {
            if (key !== 'original') {
                html += `<iframe id="dub-${key}"
                    src="https://www.youtube.com/embed/${version.id}?enablejsapi=1&controls=0&modestbranding=1&rel=0"
                    style="display:none"
                    allow="autoplay; encrypted-media"></iframe>`;
            }
        });

        container.innerHTML = html;

        this.state.currentMode = 'original';
        this.state.isReady = false;
        this.state.userSeeking = false;

        if (YTReady) {
            this.setupPlayersWhenReady();
        }
    },

    setupPlayersWhenReady() {
        if (!window.YT || !window.YT.Player) {
            setTimeout(() => this.setupPlayersWhenReady(), 500);
            return;
        }

        try {
            this.state.mainPlayer = new YT.Player('dub-main', {
                events: {
                    'onReady': () => {
                        this.state.isReady = true;
                        console.log('Main player ready');
                    },
                    'onStateChange': (e) => this.onMainPlayerStateChange(e)
                }
            });
        } catch (e) {
            console.error('Main player error:', e);
        }

        document.querySelectorAll('[id^="dub-"]').forEach(el => {
            if (el.id === 'dub-main') return;
            
            const key = el.id.replace('dub-', '');
            try {
                this.state.audioPlayers[key] = new YT.Player(el.id, {
                    events: {
                        'onReady': () => {
                            console.log(`Audio player ${key} ready`);
                            this.updateAudioSeekbar();
                        },
                        'onStateChange': (e) => this.onAudioPlayerStateChange(e, key)
                    }
                });
            } catch (e) {
                console.error(`Audio player ${key} error:`, e);
            }
        });
    },

    onMainPlayerStateChange(event) {
        if (this.state.currentMode === 'original') return;

        const audioPlayer = this.state.audioPlayers[this.state.currentMode];
        if (!audioPlayer) return;

        try {
            if (event.data === YT.PlayerState.PLAYING) {
                const mainTime = this.state.mainPlayer.getCurrentTime();
                audioPlayer.seekTo(mainTime, true);
                audioPlayer.playVideo();
                this.startAudioTimeUpdate();
            } else if (event.data === YT.PlayerState.PAUSED) {
                audioPlayer.pauseVideo();
                this.stopAudioTimeUpdate();
            } else if (event.data === YT.PlayerState.ENDED) {
                audioPlayer.stopVideo();
                this.stopAudioTimeUpdate();
            }
        } catch (e) {
            console.warn('Player state change error:', e);
        }
    },

    onAudioPlayerStateChange(event, key) {
        if (key !== this.state.currentMode) return;

        if (event.data === YT.PlayerState.PLAYING) {
            this.startAudioTimeUpdate();
        } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
            this.stopAudioTimeUpdate();
        }
    },

    startAudioTimeUpdate() {
        if (this.audioTimeUpdateInterval) return;

        this.audioTimeUpdateInterval = setInterval(() => {
            if (!this.state.userSeeking) {
                this.updateAudioSeekbar();
            }
        }, 200);
    },

    stopAudioTimeUpdate() {
        if (this.audioTimeUpdateInterval) {
            clearInterval(this.audioTimeUpdateInterval);
            this.audioTimeUpdateInterval = null;
        }
    },

    updateAudioSeekbar() {
        if (this.state.currentMode === 'original') {
            const seek = document.getElementById('videoSeek');
            seek.style.display = 'none';
            document.getElementById('currentTime').textContent = '00:00';
            document.getElementById('totalTime').textContent = '00:00';
            return;
        }

        const audioPlayer = this.state.audioPlayers[this.state.currentMode];
        if (!audioPlayer) return;

        try {
            const duration = audioPlayer.getDuration();
            const current = audioPlayer.getCurrentTime();

            if (duration > 0) {
                const seek = document.getElementById('videoSeek');
                seek.style.display = 'block';
                seek.max = duration;
                seek.value = current;

                document.getElementById('currentTime').textContent = Utils.formatTime(current);
                document.getElementById('totalTime').textContent = Utils.formatTime(duration);
            }
        } catch (e) {
            console.warn('Seekbar update error:', e);
        }
    },

    setMode(mode) {
        if (mode === this.state.currentMode) return;

        this.stopAudioTimeUpdate();

        try {
            if (mode === 'original') {
                this.state.mainPlayer.unMute();
                
                Object.values(this.state.audioPlayers).forEach(player => {
                    try {
                        player.pauseVideo();
                        player.mute();
                    } catch (e) {}
                });

                const seek = document.getElementById('videoSeek');
                seek.style.display = 'none';
            } else {
                this.state.mainPlayer.mute();
                
                Object.entries(this.state.audioPlayers).forEach(([key, player]) => {
                    try {
                        if (key === mode) {
                            player.unMute();
                            
                            const mainTime = this.state.mainPlayer.getCurrentTime();
                            player.seekTo(mainTime, true);
                            
                            if (this.state.mainPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                                player.playVideo();
                                this.startAudioTimeUpdate();
                            }
                        } else {
                            player.pauseVideo();
                            player.mute();
                        }
                    } catch (e) {}
                });

                this.updateAudioSeekbar();
            }

            this.state.currentMode = mode;
            console.log('Mode changed to:', mode);
        } catch (e) {
            console.error('Error setting mode:', e);
        }
    },

    seekAudio(time) {
        if (this.state.currentMode === 'original') return;

        const audioPlayer = this.state.audioPlayers[this.state.currentMode];
        if (!audioPlayer) return;

        try {
            audioPlayer.seekTo(time, true);
        } catch (e) {
            console.warn('Audio seek error:', e);
        }
    },

    cleanup() {
        this.stopAudioTimeUpdate();
        this.state.mainPlayer = null;
        this.state.audioPlayers = {};
        this.state.isReady = false;
        this.state.currentMode = 'original';
        this.state.userSeeking = false;
    }
};

// ============================================
// APPLICATION STATE
// ============================================
const App = {
    currentView: 'home',
    currentSeries: null,
    currentEpisode: null,
    dubEnabled: false,
    lastDubMode: localStorage.getItem('last_dub') || 'arabic',
    dubSelectorVisible: false,
    dubToggleLongPressTimer: null,

    init() {
    const saved = sessionStorage.getItem('last_view');

    if (saved) {
        const state = JSON.parse(saved);

        if (state.view === 'video') {
            this.currentSeries = LIBRARY.series.find(s => s.id === state.seriesId);
            this.playEpisode(state.episodeId);
        } 
        else if (state.view === 'series') {
            this.viewSeries(state.seriesId);
        } 
        else {
            this.renderHome();
        }
    } else {
        this.renderHome();
    }

    Comments.init();
    this.setupDubToggle();
    this.setupVideoSeek();
},
    setupDubToggle() {
        const btn = document.getElementById('dubToggle');
        let isLongPress = false;

        const handleDubToggle = () => {
            if (App.currentView !== 'video') return;
            App.toggleDub();
        };

        const handleDubMenu = () => {
            if (App.currentView !== 'video') return;
            App.toggleDubSelector();
        };

        btn.addEventListener('mousedown', () => {
            if (App.currentView !== 'video') return;
            isLongPress = false;
            App.dubToggleLongPressTimer = setTimeout(() => {
                isLongPress = true;
                handleDubMenu();
            }, CONFIG.LONG_PRESS_DURATION);
        });

        btn.addEventListener('mouseup', () => {
            if (App.dubToggleLongPressTimer) {
                clearTimeout(App.dubToggleLongPressTimer);
            }
            if (!isLongPress) {
                handleDubToggle();
            }
        });

        btn.addEventListener('touchstart', () => {
            if (App.currentView !== 'video') return;
            isLongPress = false;
            App.dubToggleLongPressTimer = setTimeout(() => {
                isLongPress = true;
                handleDubMenu();
            }, CONFIG.LONG_PRESS_DURATION);
        });

        btn.addEventListener('touchend', (e) => {
            if (App.dubToggleLongPressTimer) {
                clearTimeout(App.dubToggleLongPressTimer);
            }
            e.preventDefault();
            if (!isLongPress) {
                handleDubToggle();
            }
        });

        btn.addEventListener('contextmenu', (e) => e.preventDefault());
    },

    setupVideoSeek() {
        const seek = document.getElementById('videoSeek');

        seek.addEventListener('mousedown', () => {
            DubEngine.state.userSeeking = true;
        });

        seek.addEventListener('touchstart', () => {
            DubEngine.state.userSeeking = true;
        });

        seek.addEventListener('input', (e) => {
            const time = Number(e.target.value);
            DubEngine.seekAudio(time);
            document.getElementById('currentTime').textContent = Utils.formatTime(time);
        });

        seek.addEventListener('mouseup', () => {
            DubEngine.state.userSeeking = false;
        });

        seek.addEventListener('touchend', () => {
            DubEngine.state.userSeeking = false;
        });

        const preDubNotice = document.getElementById('preDubNotice');
        const dubArrows = document.getElementById('dubArrows');
        const legacySeek = document.getElementById('legacySeek');

        function showDubControls() {
            preDubNotice.classList.add('hidden');
            legacySeek.classList.add('hidden');
            dubArrows.classList.remove('hidden');
        }

        function hideDubControls() {
            dubArrows.classList.add('hidden');
            legacySeek.classList.add('hidden');
            preDubNotice.classList.remove('hidden');
        }

        const originalToggleDub = App.toggleDub.bind(App);
        App.toggleDub = function () {
            originalToggleDub();

            if (this.dubEnabled) {
                showDubControls();
            } else {
                hideDubControls();
            }
        };

        document.getElementById('back1').onclick = () => {
            const p = DubEngine.state.audioPlayers[DubEngine.state.currentMode];
            if (p) p.seekTo(Math.max(0, p.getCurrentTime() - 1), true);
        };

        document.getElementById('forward1').onclick = () => {
            const p = DubEngine.state.audioPlayers[DubEngine.state.currentMode];
            if (p) p.seekTo(p.getCurrentTime() + 1, true);
        };
    },

    toggleDub() {
        Utils.playHaptic();
        this.dubEnabled = !this.dubEnabled;

        const btn = document.getElementById('dubToggle');
        if (this.dubEnabled) {
            btn.classList.add('active');
            btn.querySelector('.icon').textContent = 'üîä';
            DubEngine.setMode(this.lastDubMode);
        } else {
            btn.classList.remove('active');
            btn.querySelector('.icon').textContent = 'üîá';
            DubEngine.setMode('original');
        }
    },

    toggleDubSelector() {
        const selector = document.getElementById('dubSelector');
        this.dubSelectorVisible = !this.dubSelectorVisible;

        if (this.dubSelectorVisible) {
            selector.style.display = 'block';
            selector.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            selector.style.display = 'none';
        }
    },

    renderHome() {
    const lang = document.documentElement.getAttribute('data-lang');
    const t = TRANSLATIONS[lang];

    document.getElementById('libraryView').classList.remove('hidden');
    document.getElementById('videoView').classList.add('hidden');
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('breadcrumbText').textContent = t.library;

    const grid = document.getElementById('libraryGrid');
    grid.innerHTML = LIBRARY.series.map(series => `
        <div class="library-item" onclick="App.viewSeries('${series.id}')">
            <div class="item-cover">
                <img src="${series.cover}" alt="${series.title}">
            </div>
            <div class="item-info">
                <div class="item-title">${Utils.sanitize(series.title)}</div>
                <div class="item-subtitle">${t.episodeCount(series.episodes.length)}</div>
            </div>
        </div>
    `).join('');

    this.currentView = 'home';
    this.dubSelectorVisible = false;
    Comments.pauseAutoRefresh();
    DubEngine.cleanup();

    
    sessionStorage.removeItem('last_view');
},

    viewSeries(seriesId) {
        const lang = document.documentElement.getAttribute('data-lang');
        const t = TRANSLATIONS[lang];

        this.currentSeries = LIBRARY.series.find(s => s.id === seriesId);
        if (!this.currentSeries) return;

        document.getElementById('libraryView').classList.remove('hidden');
        document.getElementById('videoView').classList.add('hidden');
        document.getElementById('backBtn').style.display = 'inline-flex';
        document.getElementById('backBtn').textContent = t.back;
        document.getElementById('libraryTitle').textContent = this.currentSeries.title;
        document.getElementById('breadcrumbText').textContent = this.currentSeries.title;

        const grid = document.getElementById('libraryGrid');
        grid.innerHTML = this.currentSeries.episodes.map(ep => `
            <div class="library-item" onclick="App.playEpisode('${ep.id}')">
                <div class="item-cover episode" style="background-image: url('${ep.cover}')">
                    <span class="play-icon">‚ñ∂</span>
                </div>
                <div class="item-info">
                    <div class="item-title">${Utils.sanitize(ep.title)}</div>
                    <div class="item-subtitle">${Utils.sanitize(ep.description)}</div>
                </div>
            </div>
        `).join('');

        this.currentView = 'series';
this.dubSelectorVisible = false;
Comments.pauseAutoRefresh();
DubEngine.cleanup();

sessionStorage.setItem('last_view', JSON.stringify({
    view: 'series',
    seriesId
}));
    },

    async playEpisode(episodeId) {
        const lang = document.documentElement.getAttribute('data-lang');
        const t = TRANSLATIONS[lang];

        if (!this.currentSeries) return;
        this.currentEpisode = this.currentSeries.episodes.find(e => e.id === episodeId);
        if (!this.currentEpisode) return;

        document.getElementById('libraryView').classList.add('hidden');
        document.getElementById('videoView').classList.remove('hidden');
        document.getElementById('backBtn').style.display = 'inline-flex';
        document.getElementById('backBtn').textContent = t.back;
        document.getElementById('breadcrumbText').textContent = this.currentEpisode.title;

        document.getElementById('videoTitle').textContent = this.currentEpisode.title;
        document.getElementById('videoDescription').textContent = this.currentEpisode.description;

        this.setupDubButtons();

        const mainId = this.currentEpisode.versions.original.id;
        await DubEngine.init(mainId, this.currentEpisode.versions);

        this.dubEnabled = false;
        this.dubSelectorVisible = false;
        document.getElementById('dubToggle').classList.remove('active');
        document.getElementById('dubToggle').querySelector('.icon').textContent = 'üîá';

        const seek = document.getElementById('videoSeek');
        seek.style.display = 'none';
        seek.value = 0;
        document.getElementById('currentTime').textContent = '00:00';
        document.getElementById('totalTime').textContent = '00:00';

        document.getElementById('preDubNotice').classList.remove('hidden');
        document.getElementById('dubArrows').classList.add('hidden');
        document.getElementById('legacySeek').classList.add('hidden');

        this.currentView = 'video';
Comments.load();

sessionStorage.setItem('last_view', JSON.stringify({
    view: 'video',
    seriesId: this.currentSeries.id,
    episodeId
}));
    },

    setupDubButtons() {
        const lang = document.documentElement.getAttribute('data-lang');
        const t = TRANSLATIONS[lang];
        const versions = this.currentEpisode.versions;
        const dubButtons = document.getElementById('dubButtons');
        const dubSelector = document.getElementById('dubSelector');

        if (!versions || Object.keys(versions).length <= 1) {
            dubSelector.style.display = 'none';
            return;
        }

        dubSelector.style.display = 'none';
        this.dubSelectorVisible = false;
        document.getElementById('dubTitle').textContent = t.dubTitle;

        dubButtons.innerHTML = Object.entries(versions).map(([key, version]) => `
            <button 
                class="dub-btn ${key === 'original' ? 'active' : ''}" 
                onclick="App.selectDubVersion('${key}', this)"
            >
                <span class="dub-icon">${version.icon}</span>
                <span>${version.name}</span>
            </button>
        `).join('');

        this.updateStatusIndicator('original');
    },

    updateStatusIndicator(mode) {
        const lang = document.documentElement.getAttribute('data-lang');
        const t = TRANSLATIONS[lang];
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        statusText.textContent = t.statusMessages[mode] || t.statusMessages.original;

        if (mode === 'original') {
            statusDot.classList.remove('active');
        } else {
            statusDot.classList.add('active');
        }
    },

    selectDubVersion(versionKey, button) {
        Utils.playHaptic();

        document.querySelectorAll('.dub-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');

        this.updateStatusIndicator(versionKey);

        if (versionKey === 'original') {
            this.dubEnabled = false;
            document.getElementById('dubToggle').classList.remove('active');
            document.getElementById('dubToggle').querySelector('.icon').textContent = 'üîá';
            DubEngine.setMode('original');
        } else {
            this.lastDubMode = versionKey;
            localStorage.setItem('last_dub', versionKey);
            this.dubEnabled = true;
            document.getElementById('dubToggle').classList.add('active');
            document.getElementById('dubToggle').querySelector('.icon').textContent = 'üîä';
            DubEngine.setMode(versionKey);
        }
    },

    goHome() {
        if (this.currentView === 'video') {
            this.viewSeries(this.currentSeries.id);
        } else if (this.currentView === 'series') {
            this.renderHome();
        }
    }
};

// ============================================
// COMMENTS MANAGER
// ============================================
const Comments = {
    userCommentId: localStorage.getItem('watch_vip_user_comment_id'),
    autoRefreshInterval: null,
    isRefreshing: false,
    lastSubmitTime: 0,

    async init() {
    const form = document.getElementById('commentForm');
    form.addEventListener('submit', e => {
        e.preventDefault();
        this.send();
    });

    this.startAutoRefresh();
},

    startAutoRefresh() {
        if (this.autoRefreshInterval) clearInterval(this.autoRefreshInterval);

        this.autoRefreshInterval = setInterval(() => {
            if (App.currentView === 'video') {
                this.load();
            }
        }, CONFIG.REFRESH_INTERVAL);
    },

    pauseAutoRefresh() {
        const indicator = document.getElementById('updateIndicator');
        if (indicator) {
            if (App.currentView === 'video') {
                indicator.classList.remove('paused');
            } else {
                indicator.classList.add('paused');
            }
        }
    },

    async send() {
        const lang = document.documentElement.getAttribute('data-lang');
        const t = TRANSLATIONS[lang];
        const now = Date.now();

        if (now - this.lastSubmitTime < CONFIG.SUBMIT_COOLDOWN) {
            Utils.status(t.rateLimitError, 'error');
            return;
        }

        if (this.userCommentId) {
            Utils.status(t.pending, 'info');
            return;
        }

        const name = document.getElementById('commentName').value.trim();
        const text = document.getElementById('commentText').value.trim();

        if (!text) {
            Utils.status(t.empty, 'error');
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ ' + t.submitting;

        try {
            const res = await API.submit(name || null, text);
            this.userCommentId = res.commentId;
            localStorage.setItem('watch_vip_user_comment_id', res.commentId);
            this.lastSubmitTime = now;
            Utils.status(t.success, 'success');
            Utils.playHaptic();
            document.getElementById('commentText').value = '';
            document.getElementById('commentName').value = '';
            await this.load();
        } catch (e) {
            Utils.status(t.error, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = t.submit;
        }
    },

    async load() {
        if (this.isRefreshing || App.currentView !== 'video') return;
        this.isRefreshing = true;

        try {
            const lang = document.documentElement.getAttribute('data-lang');
            const t = TRANSLATIONS[lang];
            const list = await API.comments();
            const box = document.getElementById('commentsListContainer');

            document.getElementById('commentsCount').textContent = t.commentCount(list.length);

            if (!list.length) {
                box.innerHTML = `<div class="no-comments">${t.noComments}</div>`;
                this.isRefreshing = false;
                return;
            }

            if (this.userCommentId && !list.some(c => c.commentId === this.userCommentId)) {
                localStorage.removeItem('watch_vip_user_comment_id');
                this.userCommentId = null;
            }

            list.sort((a,b)=>{
                if (a.commentId === this.userCommentId) return -1;
                if (b.commentId === this.userCommentId) return 1;
                return b.timestamp - a.timestamp;
            });

            box.innerHTML = `
                <div class="comments-list">
                    ${list.map(c=>`
                        <div class="comment-item ${c.commentId===this.userCommentId?'user-comment':''}"
                             data-id="${c.commentId}">
                            <div class="comment-header">
                                <div class="comment-author">
                                    ${Utils.sanitize(c.displayName)}
                                    ${c.verified ? `<svg class="verified-svg" viewBox="0 0 24 24" fill="#1da1f2">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                    </svg>` : ''}
                                </div>
                                <span class="comment-time">${Utils.timeAgo(c.timestamp)}</span>
                            </div>
                            <div class="comment-text">${Utils.sanitize(c.text)}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            this.bindClicks();
        } finally {
            this.isRefreshing = false;
        }
    },

    bindClicks() {
        const lang = document.documentElement.getAttribute('data-lang');
        const t = TRANSLATIONS[lang];

        document.querySelectorAll('.user-comment').forEach(el=>{
            let lastClick = 0;
            el.addEventListener('click', () => {
                const now = Date.now();
                if (now - lastClick < 300) {
                    localStorage.removeItem('watch_vip_user_comment_id');
                    this.userCommentId = null;
                    Utils.status(t.canComment, 'success');
                    Utils.playHaptic();
                    this.load();
                }
                lastClick = now;
            });
        });
    }
};

// ============================================
// LANGUAGE MANAGEMENT
// ============================================
function applyLanguage(lang) {
    const t = TRANSLATIONS[lang];
    document.documentElement.setAttribute('data-lang', lang);
    localStorage.setItem('site_lang', lang);

    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿµŸàÿµ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    document.getElementById('libraryTitle').textContent = t.library;
    document.getElementById('labelName').textContent = t.labelName;
    document.getElementById('hintName').textContent = t.hintName;
    document.getElementById('labelComment').textContent = t.labelComment;
    document.getElementById('commentName').placeholder = t.placeholderName;
    document.getElementById('commentText').placeholder = t.placeholderComment;
    document.getElementById('submitBtn').textContent = t.submit;
    document.getElementById('loadingText').textContent = t.loading;
    document.getElementById('dubTitle').textContent = t.dubTitle;
    document.getElementById('dubToggle').title = t.dubHint;
    document.getElementById('appTitle').textContent = t.appTitle;
    document.getElementById('dubLongPressHint').textContent = t.dubLongPressHint;
    document.getElementById('preDubNotice').textContent = t.preDubNotice;
    document.getElementById('seekHint').textContent = t.seekHint;
    document.getElementById('audioLabel').textContent = t.audioLabel;
    document.getElementById('commentsTitle').textContent = t.comments;

    const langButton = document.getElementById('langToggle');
    const langLabels = {
        ar: 'ÿßŸÑŸÑÿ∫ÿ©',
        en: 'Lang',
        fr: 'Langue',
        ja: 'Ë®ÄË™û'
    };
    langButton.textContent = langLabels[lang] || 'Lang';
    langButton.title = t.langButtonLabel;

    document.querySelectorAll('#langMenu button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.lang === lang) {
            btn.classList.add('active');
        }
    });

    // ÿ•ÿπÿßÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ≠ÿßŸÑŸä ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ≠ÿßŸÑÿ©
    if (App.currentView === 'home') {
        document.getElementById('breadcrumbText').textContent = t.library;
        document.getElementById('backBtn').textContent = t.back;
        
        // ÿ•ÿπÿßÿØÿ© ÿ±ÿ≥ŸÖ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        const grid = document.getElementById('libraryGrid');
        grid.innerHTML = LIBRARY.series.map(series => `
            <div class="library-item" onclick="App.viewSeries('${series.id}')">
                <div class="item-cover">
                    <img src="${series.cover}" alt="${series.title}">
                </div>
                <div class="item-info">
                    <div class="item-title">${Utils.sanitize(series.title)}</div>
                    <div class="item-subtitle">${t.episodeCount(series.episodes.length)}</div>
                </div>
            </div>
        `).join('');
    } 
    else if (App.currentView === 'series' && App.currentSeries) {
        document.getElementById('breadcrumbText').textContent = App.currentSeries.title;
        document.getElementById('backBtn').textContent = t.back;
        
        // ÿ•ÿπÿßÿØÿ© ÿ±ÿ≥ŸÖ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≠ŸÑŸÇÿßÿ™
        const grid = document.getElementById('libraryGrid');
        grid.innerHTML = App.currentSeries.episodes.map(ep => `
            <div class="library-item" onclick="App.playEpisode('${ep.id}')">
                <div class="item-cover episode" style="background-image: url('${ep.cover}')">
                    <span class="play-icon">‚ñ∂</span>
                </div>
                <div class="item-info">
                    <div class="item-title">${Utils.sanitize(ep.title)}</div>
                    <div class="item-subtitle">${Utils.sanitize(ep.description)}</div>
                </div>
            </div>
        `).join('');
    }
    else if (App.currentView === 'video' && App.currentEpisode) {
        document.getElementById('breadcrumbText').textContent = App.currentEpisode.title;
        document.getElementById('backBtn').textContent = t.back;
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿØÿ®ŸÑÿ¨ÿ©
        const versions = App.currentEpisode.versions;
        const dubButtons = document.getElementById('dubButtons');
        const currentMode = DubEngine.state.currentMode;
        
        dubButtons.innerHTML = Object.entries(versions).map(([key, version]) => `
            <button 
                class="dub-btn ${key === currentMode ? 'active' : ''}" 
                onclick="App.selectDubVersion('${key}', this)"
            >
                <span class="dub-icon">${version.icon}</span>
                <span>${version.name}</span>
            </button>
        `).join('');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ≠ÿßŸÑÿ©
        App.updateStatusIndicator(currentMode);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿßÿØ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™
        const commentsContainer = document.getElementById('commentsListContainer');
        const currentCommentCount = commentsContainer.querySelectorAll('.comment-item').length;
        document.getElementById('commentsCount').textContent = t.commentCount(currentCommentCount);
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ŸàŸÇÿßÿ™
        Comments.load();
    }
}

const langToggle = document.getElementById('langToggle');
const langMenu = document.getElementById('langMenu');

langToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    langMenu.classList.toggle('hidden');
});

langMenu.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
        applyLanguage(btn.dataset.lang);
        langMenu.classList.add('hidden');
        Utils.playHaptic();
    });
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('#langToggle') && !e.target.closest('#langMenu')) {
        langMenu.classList.add('hidden');
    }
});

const savedLang = localStorage.getItem('site_lang') || 'ar';
applyLanguage(savedLang);

document.addEventListener('DOMContentLoaded', ()=>App.init());
    </script>
</body>
</html>



