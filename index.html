<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشاهدة المسلسلات</title>
    <style>
        :root {
            --primary-color: #f47521;
            --dark-bg: #23252b;
            --darker-bg: #191b1f;
            --light-text: #ffffff;
            --gray-text: #9fadbd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: var(--darker-bg);
            color: var(--light-text);
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--dark-bg);
            padding: 15px 0;
            border-bottom: 2px solid var(--primary-color);
        }

        header h1 {
            text-align: center;
            color: var(--primary-color);
        }

        .player-section {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-container {
            width: 100%;
            background-color: var(--dark-bg);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            padding-top: 56.25%; /* 16:9 نسبة العرض للفيديو */
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            background-color: var(--dark-bg);
            padding: 15px;
            border-radius: 8px;
        }

        .episodes-navigation {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .episode-buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .episode-button {
            padding: 8px 15px;
            background-color: var(--dark-bg);
            color: var(--gray-text);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
        }

        .episode-button.active {
            background-color: var(--primary-color);
            color: var(--light-text);
        }

        .admin-panel {
            margin-top: 30px;
            background-color: var(--dark-bg);
            padding: 15px;
            border-radius: 8px;
            display: none; /* إخفاء لوحة الإدارة بشكل افتراضي */
        }

        .admin-panel h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .settings-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .settings-row label {
            color: var(--gray-text);
            min-width: 150px;
        }

        .settings-row input, .settings-row select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--gray-text);
            background-color: var(--darker-bg);
            color: var(--light-text);
            flex-grow: 1;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 15px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .admin-access {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .admin-access input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--gray-text);
            background-color: var(--darker-bg);
            color: var(--light-text);
            width: 250px;
        }

        .content-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--darker-bg);
            border-radius: 5px;
            padding: 10px;
        }

        .content-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background-color: var(--dark-bg);
            border-radius: 5px;
            border-right: 3px solid var(--primary-color);
        }

        .content-item.break {
            border-right-color: #4a90e2;
        }

        .content-item-info {
            flex-grow: 1;
        }

        .content-item-name {
            font-weight: bold;
            color: var(--light-text);
        }

        .content-item-url {
            font-size: 0.8em;
            color: var(--gray-text);
            word-break: break-all;
        }

        .content-item-actions {
            display: flex;
            gap: 5px;
        }

        .continuous-play {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark-bg);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: var(--gray-text);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(32px);
            background-color: white;
        }

        @media (max-width: 768px) {
            .settings-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .episode-input {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>مشاهدة المسلسلات</h1>
        </div>
    </header>

    <div class="container">
        <div class="player-section">
            <div class="video-container">
                <iframe id="video-player" frameborder="0" allowfullscreen></iframe>
            </div>

            <div class="controls">
                <div class="episodes-navigation">
                    <button id="prev-episode">الحلقة السابقة</button>
                    <div>
                        <span>الحلقة: </span>
                        <span id="current-episode">0</span>
                        <span> / </span>
                        <span id="total-episodes">0</span>
                    </div>
                    <button id="next-episode">الحلقة التالية</button>
                </div>
                
                <div class="continuous-play">
                    <div class="switch-container">
                        <label for="continuous-play-toggle">البث المستمر:</label>
                        <label class="switch">
                            <input type="checkbox" id="continuous-play-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="episode-buttons" id="episode-buttons"></div>
            
            <div class="admin-access">
                <input type="password" id="access-code" placeholder="أدخل كود الوصول للإعدادات">
                <button id="access-btn">دخول</button>
            </div>
        </div>

        <div class="admin-panel" id="admin-panel">
            <h3>إدارة المحتوى</h3>
            
            <div class="settings-row">
                <label for="content-type">نوع المحتوى:</label>
                <select id="content-type">
                    <option value="episode">حلقة</option>
                    <option value="break">فاصل</option>
                </select>
            </div>
            
            <div class="settings-row">
                <label for="content-name">اسم المحتوى:</label>
                <input type="text" id="content-name" placeholder="مثال: الحلقة الأولى">
            </div>
            
            <div class="settings-row">
                <label for="content-number">الترتيب:</label>
                <input type="number" id="content-number" min="1" value="1">
            </div>
            
            <div class="settings-row">
                <label for="content-url">رابط المحتوى:</label>
                <input type="text" id="content-url" placeholder="أدخل رابط الفيديو من Google Drive">
            </div>
            
            <button id="add-content-btn">إضافة المحتوى</button>
            
            <h3 style="margin-top: 20px;">قائمة المحتوى</h3>
            <div class="content-list" id="content-list"></div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // عناصر DOM
            const videoPlayer = document.getElementById('video-player');
            const prevEpisodeBtn = document.getElementById('prev-episode');
            const nextEpisodeBtn = document.getElementById('next-episode');
            const currentEpisodeSpan = document.getElementById('current-episode');
            const totalEpisodesSpan = document.getElementById('total-episodes');
            const episodeButtonsContainer = document.getElementById('episode-buttons');
            const notification = document.getElementById('notification');
            const accessCodeInput = document.getElementById('access-code');
            const accessBtn = document.getElementById('access-btn');
            const adminPanel = document.getElementById('admin-panel');
            const contentTypeSelect = document.getElementById('content-type');
            const contentNameInput = document.getElementById('content-name');
            const contentNumberInput = document.getElementById('content-number');
            const contentUrlInput = document.getElementById('content-url');
            const addContentBtn = document.getElementById('add-content-btn');
            const contentListContainer = document.getElementById('content-list');
            const continuousPlayToggle = document.getElementById('continuous-play-toggle');
            
            // كود الوصول للإعدادات
            const ACCESS_CODE = "F@20D&o0tTrR2#D0•Hh";
            
            // متغيرات لإدارة الحالة
            let currentIndex = 0;
            let contentItems = [];
            let isAdmin = false;
            let isContinuousPlay = false;
            let isPlayingContent = false;
            
            // استعادة البيانات المحفوظة (إن وجدت)
            loadSavedData();
            
            // الاستماع للأحداث
            prevEpisodeBtn.addEventListener('click', () => navigateContent(-1));
            nextEpisodeBtn.addEventListener('click', () => navigateContent(1));
            accessBtn.addEventListener('click', checkAccessCode);
            addContentBtn.addEventListener('click', addContentItem);
            continuousPlayToggle.addEventListener('click', toggleContinuousPlay);
            
            // التحقق من كود الوصول
            function checkAccessCode() {
                if (accessCodeInput.value === ACCESS_CODE) {
                    isAdmin = true;
                    adminPanel.style.display = 'block';
                    accessCodeInput.value = '';
                    showNotification('تم الوصول إلى لوحة الإدارة بنجاح');
                    renderContentList();
                } else {
                    showNotification('كود الوصول غير صحيح');
                }
            }
            
            // إضافة عنصر محتوى (حلقة أو فاصل)
            function addContentItem() {
                const type = contentTypeSelect.value;
                const name = contentNameInput.value.trim();
                const number = parseInt(contentNumberInput.value) || 1;
                const url = contentUrlInput.value.trim();
                
                if (!name) {
                    showNotification('الرجاء إدخال اسم المحتوى');
                    return;
                }
                
                if (!url) {
                    showNotification('الرجاء إدخال رابط المحتوى');
                    return;
                }
                
                // استخراج معرف الملف من رابط Google Drive
                const fileId = extractGoogleDriveFileId(url);
                if (!fileId) {
                    showNotification('رابط غير صالح. الرجاء إدخال رابط صحيح من Google Drive');
                    return;
                }
                
                // التحقق من عدم تكرار الرابط
                const isDuplicate = contentItems.some(item => {
                    const itemFileId = extractGoogleDriveFileId(item.url);
                    return itemFileId === fileId;
                });
                
                if (isDuplicate) {
                    showNotification('هذا الرابط موجود بالفعل في القائمة');
                    return;
                }
                
                // إضافة عنصر المحتوى
                const newItem = {
                    type,
                    name,
                    number,
                    url
                };
                
                contentItems.push(newItem);
                
                // ترتيب العناصر حسب الرقم
                contentItems.sort((a, b) => a.number - b.number);
                
                // تحديث واجهة المستخدم
                renderContentList();
                createEpisodeButtons();
                saveData();
                
                // مسح حقول الإدخال
                contentNameInput.value = '';
                contentNumberInput.value = number + 1;
                contentUrlInput.value = '';
                
                showNotification(`تم إضافة ${type === 'episode' ? 'الحلقة' : 'الفاصل'} بنجاح`);
            }
            
            // عرض قائمة المحتوى في لوحة الإدارة
            function renderContentList() {
                contentListContainer.innerHTML = '';
                
                if (contentItems.length === 0) {
                    contentListContainer.innerHTML = '<p>لا يوجد محتوى في القائمة</p>';
                    return;
                }
                
                contentItems.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = `content-item ${item.type}`;
                    
                    const itemInfo = document.createElement('div');
                    itemInfo.className = 'content-item-info';
                    
                    const itemName = document.createElement('div');
                    itemName.className = 'content-item-name';
                    itemName.textContent = `${item.number}. ${item.name} (${item.type === 'episode' ? 'حلقة' : 'فاصل'})`;
                    
                    const itemUrl = document.createElement('div');
                    itemUrl.className = 'content-item-url';
                    itemUrl.textContent = item.url;
                    
                    itemInfo.appendChild(itemName);
                    itemInfo.appendChild(itemUrl);
                    
                    const itemActions = document.createElement('div');
                    itemActions.className = 'content-item-actions';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'حذف';
                    deleteBtn.onclick = () => deleteContentItem(index);
                    
                    itemActions.appendChild(deleteBtn);
                    
                    itemElement.appendChild(itemInfo);
                    itemElement.appendChild(itemActions);
                    
                    contentListContainer.appendChild(itemElement);
                });
            }
            
            // حذف عنصر محتوى
            function deleteContentItem(index) {
                contentItems.splice(index, 1);
                renderContentList();
                createEpisodeButtons();
                saveData();
                
                // إذا كان العنصر الحالي هو المحذوف، انتقل إلى العنصر الأول
                if (currentIndex >= contentItems.length) {
                    currentIndex = contentItems.length > 0 ? 0 : -1;
                    updateCurrentContent();
                }
                
                showNotification('تم حذف العنصر بنجاح');
            }
            
            // تبديل وضع البث المستمر
            function toggleContinuousPlay() {
                isContinuousPlay = continuousPlayToggle.checked;
                saveData();
                
                showNotification(`تم ${isContinuousPlay ? 'تفعيل' : 'إلغاء'} وضع البث المستمر`);
            }
            
            // التنقل بين عناصر المحتوى
            function navigateContent(direction) {
                // احسب فقط الحلقات وليس الفواصل إذا لم يكن في وضع البث المستمر
                if (!isContinuousPlay) {
                    const episodes = contentItems.filter(item => item.type === 'episode');
                    const currentEpisodeIndex = episodes.findIndex((_, i) => {
                        const episodeIndices = contentItems
                            .map((item, index) => item.type === 'episode' ? index : -1)
                            .filter(index => index !== -1);
                        return episodeIndices[i] === currentIndex;
                    });
                    
                    if (currentEpisodeIndex !== -1) {
                        const nextEpisodeIndex = currentEpisodeIndex + direction;
                        if (nextEpisodeIndex >= 0 && nextEpisodeIndex < episodes.length) {
                            const episodeIndices = contentItems
                                .map((item, index) => item.type === 'episode' ? index : -1)
                                .filter(index => index !== -1);
                            currentIndex = episodeIndices[nextEpisodeIndex];
                        } else {
                            showNotification('لا توجد حلقات أخرى في هذا الاتجاه');
                            return;
                        }
                    } else {
                        // إذا لم نكن على حلقة، انتقل إلى أول حلقة
                        const firstEpisodeIndex = contentItems.findIndex(item => item.type === 'episode');
                        if (firstEpisodeIndex !== -1) {
                            currentIndex = firstEpisodeIndex;
                        } else {
                            showNotification('لا توجد حلقات في القائمة');
                            return;
                        }
                    }
                } else {
                    // في وضع البث المستمر، انتقل إلى العنصر التالي بغض النظر عن نوعه
                    const newIndex = currentIndex + direction;
                    if (newIndex >= 0 && newIndex < contentItems.length) {
                        currentIndex = newIndex;
                    } else {
                        showNotification('لا يوجد محتوى آخر في هذا الاتجاه');
                        return;
                    }
                }
                
                updateCurrentContent();
                saveData();
            }
            
            // تحديث المحتوى الحالي
            function updateCurrentContent() {
                if (currentIndex >= 0 && currentIndex < contentItems.length) {
                    const currentItem = contentItems[currentIndex];
                    
                    // تحديث عنوان الحلقة
                    if (currentItem.type === 'episode') {
                        const episodeNumber = countEpisodesBeforeCurrent() + 1;
                        const totalEpisodes = contentItems.filter(item => item.type === 'episode').length;
                        currentEpisodeSpan.textContent = episodeNumber;
                        totalEpisodesSpan.textContent = totalEpisodes;
                    }
                    
                    // تحميل الفيديو
                    loadContentVideo(currentItem.url);
                    
                    // تحديث أزرار المحتوى
                    updateEpisodeButtons();
                } else {
                    currentEpisodeSpan.textContent = '0';
                    videoPlayer.src = '';
                }
            }
            
            // حساب عدد الحلقات قبل العنصر الحالي
            function countEpisodesBeforeCurrent() {
                let count = 0;
                for (let i = 0; i < currentIndex; i++) {
                    if (contentItems[i].type === 'episode') {
                        count++;
                    }
                }
                return count;
            }
            
            // تحميل فيديو المحتوى
            function loadContentVideo(url) {
                // استخراج معرف الملف من رابط Google Drive
                const fileId = extractGoogleDriveFileId(url);
                if (!fileId) {
                    showNotification('رابط غير صالح');
                    return;
                }
                
                // إنشاء رابط التضمين
                const embedUrl = createProtectedEmbedUrl(fileId);
                videoPlayer.src = embedUrl;
                
                // تسجيل انتهاء الفيديو للبث المستمر
                isPlayingContent = true;
                listenForVideoEnd();
            }
            
            // الاستماع لانتهاء الفيديو من أجل البث المستمر
            function listenForVideoEnd() {
                if (!videoPlayer.contentWindow) {
                    setTimeout(listenForVideoEnd, 1000);
                    return;
                }
                
                try {
                    videoPlayer.addEventListener('load', function() {
                        try {
                            // محاولة تسجيل حدث عند انتهاء الفيديو
                            videoPlayer.contentWindow.document.addEventListener('ended', handleVideoEnd);
                        } catch (e) {
                            // في حالة فشل طريقة واحدة، نستخدم طريقة التحقق الدوري
                            checkVideoStatus();
                        }
                    });
                } catch (e) {
                    // استخدام التحقق الدوري في حالة فشل الطرق الأخرى
                    checkVideoStatus();
                }
            }
            
            // التحقق من حالة الفيديو بشكل دوري للبث المستمر
            function checkVideoStatus() {
                if (!isPlayingContent || !isContinuousPlay) return;
                
                try {
                    // محاولة الوصول إلى عنصر الفيديو داخل الـ iframe (قد يفشل بسبب سياسة نفس المنشأ)
                    const videoElement = videoPlayer.contentWindow.document.querySelector('video');
                    if (videoElement && videoElement.ended) {
                        handleVideoEnd();
                    } else {
                        setTimeout(checkVideoStatus, 2000);
                    }
                } catch (e) {
                    // في حالة عدم القدرة على الوصول إلى الفيديو، استخدم وسيلة أخرى للتحقق
                    // مثل التحقق من تغير مصدر الـ iframe كعلامة على انتهاء الفيديو
                    setTimeout(checkVideoStatus, 2000);
                }
            }
            
            // معالجة انتهاء الفيديو (للبث المستمر)
            function handleVideoEnd() {
                if (isContinuousPlay) {
                    // الانتقال إلى العنصر التالي في البث المستمر
                    navigateContent(1);
                }
            }
            
            // إنشاء أزرار الحلقات
            function createEpisodeButtons() {
                episodeButtonsContainer.innerHTML = '';
                
                // إظهار أزرار للحلقات فقط وليس الفواصل
                const episodes = contentItems.filter(item => item.type === 'episode');
                
                episodes.forEach((episode, index) => {
                    const button = document.createElement('button');
                    button.className = 'episode-button';
                    button.textContent = index + 1;
                    button.dataset.index = contentItems.indexOf(episode);
                    
                    button.addEventListener('click', () => {
                        currentIndex = parseInt(button.dataset.index);
                        updateCurrentContent();
                        saveData();
                    });
                    
                    episodeButtonsContainer.appendChild(button);
                });
                
                updateEpisodeButtons();
            }
            
            // تحديث حالة أزرار الحلقات
            function updateEpisodeButtons() {
                const buttons = episodeButtonsContainer.querySelectorAll('.episode-button');
                
                buttons.forEach(button => {
                    const index = parseInt(button.dataset.index);
                    
                    // إزالة كل الفئات المتعلقة بالحالة
                    button.classList.remove('active');
                    
                    // إضافة الفئة المناسبة
                    if (index === currentIndex) {
                        button.classList.add('active');
                    }
                });
            }
            
            // إنشاء رابط تضمين محمي
            function createProtectedEmbedUrl(fileId) {
                return `https://drive.google.com/file/d/${fileId}/preview`;
            }
            
            // استخراج معرف الملف من رابط Google Drive
            function extractGoogleDriveFileId(url) {
                // محاولة استخراج المعرف من روابط مختلفة لـ Google Drive
                const patterns = [
                    /\/file\/d\/([^\/]+)/,  // المعرف من /file/d/FILE_ID/view
                    /id=([^&]+)/,          // المعرف من ?id=FILE_ID
                    /\/([^\/]{25,})/       // المعرف المباشر في الرابط (25+ حرفًا)
                ];
                
                for (let pattern of patterns) {
                    const match = url.match(pattern);
                    if (match && match[1]) {
                        return match[1];
                    }
                }
                
                return null;
            }
            
            // عرض إشعار
            function showNotification(message) {
                notification.textContent = message;
                notification.style.opacity = '1';
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                }, 3000);
            }
            
            // تشفير البيانات قبل التخزين
            function encryptData(data) {
                return btoa(encodeURIComponent(JSON.stringify(data)));
            }
            
            // فك تشفير البيانات المستعادة
            function decryptData(encryptedData) {
                try {
                    return JSON.parse(decodeURIComponent(atob(encryptedData)));
                } catch (error) {
                    console.error('خطأ في فك تشفير البيانات:', error);
                    return null;
                }
            }
            
            // حفظ البيانات في التخزين المحلي
            function saveData() {
                const data = {
                    currentIndex,
                    contentItems,
                    isContinuousPlay
                };
                
                // تشفير البيانات قبل التخزين
                const encryptedData = encryptData(data);
                localStorage.setItem('episodesPlayerData', encryptedData);
            }
            
            // استعادة البيانات المحفوظة
            function loadSavedData() {
                const savedData = localStorage.getItem('episodesPlayerData');
                
                if (savedData) {
                    try {
                        // فك تشفير البيانات المستعادة
                        const data = decryptData(savedData);
                        
                        if (data) {
                            // استعادة متغيرات الحالة
                            currentIndex = data.currentIndex || 0;
                            contentItems = data.contentItems || [];
                            isContinuousPlay = data.isContinuousPlay || false;
                            
                            // تحديث واجهة المستخدم
                            continuousPlayToggle.checked = isContinuousPlay;
                            createEpisodeButtons();
                            updateCurrentContent();
                        }
                    } catch (error) {
                        console.error('خطأ في استعادة البيانات المحفوظة:', error);
                    }
                }
            }

            // تحسين أمان الفيديو
            function enhanceVideoSecurity() {
                videoPlayer.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-presentation');
                
                videoPlayer.addEventListener('load', function() {
                    try {
                        const frameDoc = videoPlayer.contentDocument || videoPlayer.contentWindow.document;
                        const links = frameDoc.querySelectorAll('a[href*="google.com"]');
                        links.forEach(link => {
                            link.removeAttribute('href');
                            link.style.pointerEvents = 'none';
                        });
                    } catch (e) {
                        // خطأ الوصول عبر النطاق متوقع بسبب سياسة الأمان
                    }
                });
            }
            
            // تطبيق تحسينات الأمان
            enhanceVideoSecurity();
        });
    </script>
</body>
</html>
